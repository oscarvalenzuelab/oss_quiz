<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SBOM Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .card {
      transition: transform 0.3s ease-in-out;
    }
    .hidden {
      display: none;
    }
    .context-box, .question-box {
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .btn-group-toggle .btn {
      min-width: 100px;
    }
    .question-number {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
    }
    .learn-box {
      margin-top: 0.5rem;
      font-size: 0.95rem;
      color: #555;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4 text-center">SBOM Quiz</h1>
    <div id="quiz"></div>

    <div class="d-flex justify-content-between mt-4">
      <button id="prevBtn" class="btn btn-secondary">Previous</button>
      <button id="nextBtn" class="btn btn-primary">Next</button>
      <button id="submitBtn" class="btn btn-success d-none">Submit</button>
    </div>

    <div id="result" class="mt-5"></div>

    <div class="text-center mt-4">
      <button class="btn btn-warning" onclick="sendTestSubmission()">üì° Send Test Data</button>
    </div>

    <script src="questions.js"></script>
    <script>
      const quizContainer = document.getElementById("quiz");
      const resultContainer = document.getElementById("result");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const submitBtn = document.getElementById("submitBtn");

      let currentQuestion = 0;
      const userAnswers = new Array(questions.length).fill(null);

      // Replace with your Google Apps Script Web App URL
      const submissionURL = "https://script.google.com/macros/s/AKfycby-QHZb8jnOuhABIu9CWLZDxWdRi2bY15X1a0pySb4vXimMd9zAU36T2oBeSwBi5tPQ/exec";

      function generateUserId() {
        return "User-" + Math.random().toString(36).substr(2, 6);
      }

      const userId = generateUserId();

      function extractContextAndQuestion(fullText) {
        const lines = fullText.trim().split("\n");
        const questionIndex = lines.findIndex(line => line.trim().endsWith("Is this correct?"));
        const context = lines.slice(0, questionIndex).join("\n");
        const question = lines[questionIndex];
        return { context, question };
      }

      function buildQuiz() {
        const output = questions.map((q, index) => {
          const { context, question } = extractContextAndQuestion(q.scenario);
          return `
            <div class="card mb-3 p-3 ${index !== 0 ? 'hidden' : ''}" id="question${index}">
              <div class="card-body">
                <div class="question-number">Question ${index + 1} of ${questions.length}</div>
                <h5 class="card-title">Scenario ${index + 1}</h5>
                <div class="context-box">
                  <pre>${context}</pre>
                </div>
                <div class="question-box">
                  <p><strong>${question}</strong></p>
                  <div class="btn-group btn-group-toggle" data-bs-toggle="buttons">
                    <input type="radio" class="btn-check" name="q${index}" id="yes${index}" value="Yes">
                    <label class="btn btn-outline-primary" for="yes${index}" onclick="checkAnswer(${index}, 'Yes')">Yes</label>

                    <input type="radio" class="btn-check" name="q${index}" id="no${index}" value="No">
                    <label class="btn btn-outline-primary" for="no${index}" onclick="checkAnswer(${index}, 'No')">No</label>
                  </div>
                </div>
                <div id="feedback${index}" class="mt-3"></div>
              </div>
            </div>
          `;
        });
        quizContainer.innerHTML = output.join("");
      }

      function checkAnswer(index, userAnswer) {
        const question = questions[index];
        const feedbackEl = document.getElementById(`feedback${index}`);
        const inputs = document.querySelectorAll(`input[name=q${index}]`);

        inputs.forEach(input => input.disabled = true);
        userAnswers[index] = userAnswer;

        if (userAnswer === question.answer) {
          feedbackEl.innerHTML = `<div class='text-success'>Correct: ${question.feedback}</div>`;
        } else {
          feedbackEl.innerHTML = `<div class='text-danger'>Incorrect: ${question.feedback}</div>`;
        }
      }

      function showQuestion(index) {
        questions.forEach((_, i) => {
          document.getElementById(`question${i}`).classList.add("hidden");
        });
        document.getElementById(`question${index}`).classList.remove("hidden");
        prevBtn.disabled = index === 0;
        nextBtn.classList.toggle("d-none", index === questions.length - 1);
        submitBtn.classList.toggle("d-none", index !== questions.length - 1);
      }

      function showResults() {
        let score = 0;
        let notes = "";

        questions.forEach((q, index) => {
          if (userAnswers[index] === q.answer) {
            score++;
          }
          notes += `
            <div class='mb-3'>
              <strong>Question ${index + 1}:</strong> ${userAnswers[index] === q.answer ? "‚úÖ Correct" : "‚ùå Incorrect"}<br>
              <div class='learn-box'><em>What we learn:</em> ${q.feedback}</div>
            </div>
          `;
        });

        resultContainer.innerHTML = `
          <div class='alert alert-info'>
            <strong>You scored ${score} out of ${questions.length}.</strong><br>
            <em>User ID:</em> ${userId}
          </div>
          <div class='card card-body mt-3'>
            <h5>Learning Notes:</h5>
            ${notes}
          </div>
        `;

        // Send to Google Sheets
        sendSubmission(userId, score, questions.length, userAnswers);
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }

      function sendSubmission(user, score, total, answers) {
        fetch(submissionURL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ user, score, total, answers })
        })
        .then(res => res.text())
        .then(txt => console.log("Submitted:", txt))
        .catch(err => console.error("Submission error:", err));
      }

      function sendTestSubmission() {
        const testUser = "TestUser-123";
        const testData = {
          user: testUser,
          score: 4,
          total: 6,
          answers: ["Yes", "No", "No", "Yes", "No", "No"]
        };
        sendSubmission(testData.user, testData.score, testData.total, testData.answers);
        alert("Test data sent as " + testUser);
      }

      buildQuiz();
      showQuestion(currentQuestion);

      prevBtn.addEventListener("click", () => {
        if (currentQuestion > 0) {
          currentQuestion--;
          showQuestion(currentQuestion);
        }
      });

      nextBtn.addEventListener("click", () => {
        if (currentQuestion < questions.length - 1) {
          currentQuestion++;
          showQuestion(currentQuestion);
        }
      });

      submitBtn.addEventListener("click", showResults);
    </script>
  </div>
</body>
</html>